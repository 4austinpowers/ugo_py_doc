<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Ugo Sparks">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Viewing 3D Volumetric Data With Matplotlib - ugo_py_doc</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Viewing 3D Volumetric Data With Matplotlib";
    var mkdocs_page_input_path = "Viewing+3D+Volumetric+Data+With+Matplotlib.md";
    var mkdocs_page_url = "/Viewing+3D+Volumetric+Data+With+Matplotlib/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-93008985-2', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ugo_py_doc</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Basics & More</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Py_CS/">Python Cheat Sheets</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python_Preliminaries/">Python Preliminaries</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python_Nice_to_Have/">Python Nice to Have</a>
                </li>
                <li class="">
                    
    <a class="" href="../Freeze_the_Code/">Freeze the Code</a>
                </li>
                <li class="">
                    
    <a class="" href="../Decorators/">Decorators</a>
                </li>
                <li class="">
                    
    <a class="" href="../Write_Better_Python/">Write Better Python with PEP</a>
                </li>
                <li class="">
                    
    <a class="" href="../Regex/">Regular Expressions (REGEX)</a>
                </li>
                <li class="">
                    
    <a class="" href="../Databases/">Databases</a>
                </li>
                <li class="">
                    
    <a class="" href="../Datetime/">Datetime</a>
                </li>
                <li class="">
                    
    <a class="" href="../Execute_Highlighted_Python_Code_in_gedit/">Execute Highlighted Python Code in gedit</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">SciPy Stack</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Scipy_CS/">Scipy Stack Cheat Sheets</a>
                </li>
                <li class="">
                    
    <a class="" href="../JN_CS/">Jupyter Notebook Cheat Sheets</a>
                </li>
                <li class="">
                    
    <a class="" href="../Scientific Python (the SciPy Stack)/">Scientific Python (the SciPy Stack)</a>
                </li>
                <li class="">
                    
    <a class="" href="../Importing Data into Python/">Importing Data into Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python for Data Science/">Python for Data Science</a>
                </li>
                <li class="">
                    
    <a class="" href="../Tidy_Data_in_Python/">Tidy Data in Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Lists/">Lists</a>
                </li>
                <li class="">
                    
    <a class="" href="../IPython Notebook/">IPython Notebook, Collection</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python Numpy Arrays/">Python Numpy Arrays</a>
                </li>
                <li class="">
                    
    <a class="" href="../Vectors and Arrays (Linear Algebra)/">Vectors and Arrays (Linear Algebra)</a>
                </li>
                <li class="">
                    
    <a class="" href="../Matplotlib, Python Plotting/">Matplotlib, Python Plotting</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Viewing 3D Volumetric Data With Matplotlib</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#interlude-getting-the-data">Interlude: Getting The Data…</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#download-the-data">Download the Data</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#back-to-plotting">… Back To Plotting</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../Seaborn, Python Statistical Data Visualization Library/">Seaborn, Python's Statistical Data Visualization Library</a>
                </li>
                <li class="">
                    
    <a class="" href="../Pandas+DataFrames/">Pandas DataFrames</a>
                </li>
                <li class="">
                    
    <a class="" href="../Write Idiomatic Pandas Code/">Write Idiomatic Pandas Code</a>
                </li>
                <li class="">
                    
    <a class="" href="../Exploratory Data Analysis/">Exploratory Data Analysis</a>
                </li>
                <li class="">
                    
    <a class="" href="../Intro to data.world in Python/">Intro to data.world in Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python+And+Excel/">Python and Excel</a>
                </li>
                <li class="">
                    
    <a class="" href="../Overview_of_scikit-learn/">Overview of scikit-learn</a>
                </li>
                <li class="">
                    
    <a class="" href="../k-NN_Linear_regression_Logit_Scaling_Centering_Noise/">k-NN, Linear regression, Logit, Scaling, Centering, Noise</a>
                </li>
                <li class="">
                    
    <a class="" href="../Time_Series_Analysis/">Time Series Analysis</a>
                </li>
                <li class="">
                    
    <a class="" href="../Sentiment_Analysis_with_Twitter/">Sentiment Analysis with Twitter</a>
                </li>
                <li class="">
                    
    <a class="" href="../EDA_Machine_Learning_Feature_Engineering_and_Kaggle/">EDA, Machine Learning, Feature Engineering, and Kaggle</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Courses</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Apprenez a programmer en Python/">Apprenez à programmer en Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Codecademy Python/">Codecademy Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Learn Python the Hard Way/">Learn Python the Hard Way</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python Code Snippets/">Python Code Snippets</a>
                </li>
                <li class="">
                    
    <a class="" href="../Introduction to Python/">Introduction to Python</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Manuals</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Automate the Boring Stuff with Python/">Automate the Boring Stuff with Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Real_Python/">Real Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Managing Your Biological Data with Python/">Managing Your Biological Data with Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python for Education/">Python for Education</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ugo_py_doc</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>SciPy Stack &raquo;</li>
        
      
    
    <li>Viewing 3D Volumetric Data With Matplotlib</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="toc"><span class="toctitle">CONTENT</span><ul>
<li><a href="#content">Content</a></li>
<li><a href="#interlude-getting-the-data">Interlude: Getting The Data…</a><ul>
<li><a href="#download-the-data">Download the Data</a></li>
</ul>
</li>
<li><a href="#back-to-plotting">… Back To Plotting</a></li>
</ul>
</div>
<hr />
<p><strong>Foreword</strong></p>
<p>Code snippets and excerpts from the tutorial. Python 3. From DataCamp.</p>
<p><strong>Some images can only be simulated with Jupyter since the images are interactive.</strong></p>
<hr />
<h3 id="content">Content<a class="headerlink" href="#content" title="Permanent link">&para;</a></h3>
<p>Image data can be taken with ordinary cameras (these are often called “natural images” in the scientific literature) or with specialized instruments, such as microscopes or telescopes.</p>
<p>The most common way to display them is using the <code>imshow</code> function of Matplotlib.</p>
<p>For example, magnetic resonance imaging (MRI) and computed tomography (CT) scans measure the 3D structure inside the human body; X-ray microtomography measures the 3D structure inside materials such as glass, or metal alloys; and light-sheet microscopes measure fluorescent particles inside biological tissues.</p>
<p>Enable the interactive matplotlib mode.</p>
<p>Other applications: spatial analysis (visualization over time), maps (layers of a neighbourhood over time), etc. </p>
<pre><code class="python">%matplotlib notebook
</code></pre>

<p>When running matplotlib in the interactive notebook mode, the open figure remains the only active figure until disabled, using the power symbol on the top-right of the figure. Do that before moving on from each plot.</p>
<pre><code class="python">import matplotlib.pyplot as plt
from skimage import data

astronaut = data.astronaut()
ihc = data.immunohistochemistry()
hubble = data.hubble_deep_field()

# Initialize the subplot panels side by side
fig, ax = plt.subplots(nrows=1, ncols=3)

# Show an image in each subplot
ax[0].imshow(astronaut)
ax[0].set_title('Natural image')
ax[1].imshow(ihc)
ax[1].set_title('Microscopy image')
ax[2].imshow(hubble)
ax[2].set_title('Telescope image');
</code></pre>

<p><strong>&gt;&gt;&gt; Interactive images here! &lt;&lt;&lt;</strong></p>
<p>These images are called 2-dimensional or 2D images. Some images are 3D, in that they have an additional depth dimension (z, or planes). These include magnetic resonance imaging (MRI) and serial section transmission electron microscopy (ssTEM), in which a sample is thinly sliced, like a salami, and each of the slices is imaged separately.</p>
<pre><code class="python">import nibabel
</code></pre>

<h3 id="interlude-getting-the-data">Interlude: Getting The Data…<a class="headerlink" href="#interlude-getting-the-data" title="Permanent link">&para;</a></h3>
<p>Dataset source: Buchel and Friston, Cortical Interactions Evaluated with Structural Equation Modelling and fMRI (1997).</p>
<pre><code class="python">import tempfile

# Create a temporary directory
d = tempfile.mkdtemp()

print(d)
</code></pre>

<pre><code>/tmp/tmp8xdzu1ad
</code></pre>
<pre><code class="python">import os

os.chdir('/home/ugo/Documents/Notebooks/DataCamp, Matplotlib tutorial')
print(os.getcwd())
</code></pre>

<pre><code>/home/ugo/Documents/Notebooks/DataCamp, Matplotlib tutorial
</code></pre>
<pre><code class="python">d = os.getcwd()
print(d)
</code></pre>

<pre><code>/home/ugo/Documents/Notebooks/DataCamp, Matplotlib tutorial
</code></pre>
<pre><code class="python"># Return the tail of the path
os.path.basename('http://google.com/attention.zip')
</code></pre>

<pre><code>'attention.zip'
</code></pre>
<h4 id="download-the-data">Download the Data<a class="headerlink" href="#download-the-data" title="Permanent link">&para;</a></h4>
<pre><code class="python">from urllib.request import urlretrieve

# Define URL
url = 'http://www.fil.ion.ucl.ac.uk/spm/download/data/attention/attention.zip'

# Retrieve the data
fn, info = urlretrieve(url, os.path.join(d, 'attention.zip'))
</code></pre>

<p>Extract it from the zip file to our temporary directory.</p>
<pre><code class="python">import zipfile

# Extract the contents into the temporary directory we created earlier
zipfile.ZipFile(fn).extractall(path=d)

# List first 10 files
[f.filename for f in zipfile.ZipFile(fn).filelist[:10]]
</code></pre>

<pre><code>['attention/',
 'attention/multi_block_regressors.mat',
 'attention/README_DATA.txt',
 'attention/factors.mat',
 'attention/functional/',
 'attention/functional/snffM00587_0201.hdr',
 'attention/functional/snffM00587_0040.img',
 'attention/functional/snffM00587_0458.hdr',
 'attention/functional/snffM00587_0185.img',
 'attention/functional/snffM00587_0018.hdr']
</code></pre>
<p>These are in the NIfTI file format. <br />
<code>nibabel</code> library provides the reader. </p>
<p>Install it with either: <code>conda install -c conda-forge nibabel</code> or <code>pip install nibabel</code>.</p>
<pre><code class="python">import nibabel

# Read the image 
struct = nibabel.load(os.path.join(d, 'attention/structural/nsM00587_0002.hdr'))

# Get a plain NumPy array, without all the metadata
struct_arr = struct.get_data()

# Plot the MRI data
from skimage import io

struct_arr = io.imread(&quot;https://s3.amazonaws.com/assets.datacamp.com/blog_assets/attention-mri.tif&quot;)

plt.imshow(struct_arr[75])
</code></pre>

<p><strong>&gt;&gt;&gt; Interactive images here! &lt;&lt;&lt;</strong></p>
<h3 id="back-to-plotting">… Back To Plotting<a class="headerlink" href="#back-to-plotting" title="Permanent link">&para;</a></h3>
<pre><code class="python"># fix the aspect parameter
plt.imshow(struct_arr[75], aspect=0.5)

# transpose the data
# horizontal slices
struct_arr2 = struct_arr.T
plt.imshow(struct_arr2[34])

# slice along a different axis
plt.imshow(struct_arr2[5])
</code></pre>

<p><strong>&gt;&gt;&gt; Interactive images here! &lt;&lt;&lt;</strong></p>
<p>Explore 3D data within Python, minimizing the need to switch contexts between data exploration and data analysis.</p>
<p>The key is to use the matplotlibevent handler API.</p>
<p>https://matplotlib.org/users/event_handling.html</p>
<p>Bind the J and K keys on the keyboard to previous slice and next slice.</p>
<pre><code class="python">def previous_slice():
    pass

def next_slice():
    pass

def process_key(event):
    if event.key == 'j':
        previous_slice()
    elif event.key == 'k':
        next_slice()
</code></pre>

<p>Use the <code>process_key</code> function to process keyboard presses and the figure canvas method <code>mpl_connect</code>.</p>
<pre><code class="python">fig, ax = plt.subplots()
ax.imshow(struct_arr[..., 43])
fig.canvas.mpl_connect('key_press_event', process_key)
</code></pre>

<p><strong>&gt;&gt;&gt; Interactive images here! &lt;&lt;&lt;</strong></p>
<p><code>imshow</code> returns an <code>AxesImage</code> object, which lives inside the matplotlib <code>Axes</code> object where all the drawing takes place, in its <code>.images</code> attribute. This object provides a convenient <code>set_array</code> method that swaps out the image.</p>
<pre><code class="python">def multi_slice_viewer(volume):
    fig, ax = plt.subplots()
    ax.volume = volume
    ax.index = volume.shape[0] // 2
    ax.imshow(volume[ax.index])
    fig.canvas.mpl_connect('key_press_event', process_key)

def process_key(event):
    fig = event.canvas.figure
    ax = fig.axes[0]
    if event.key == 'j':
        previous_slice(ax)
    elif event.key == 'k':
        next_slice(ax)
    fig.canvas.draw()

def previous_slice(ax):
    &quot;&quot;&quot;Go to the previous slice.&quot;&quot;&quot;
    volume = ax.volume
    ax.index = (ax.index - 1) % volume.shape[0]  # wrap around using %
    ax.images[0].set_array(volume[ax.index])

def next_slice(ax):
    &quot;&quot;&quot;Go to the next slice.&quot;&quot;&quot;
    volume = ax.volume
    ax.index = (ax.index + 1) % volume.shape[0]
    ax.images[0].set_array(volume[ax.index])
</code></pre>

<p>Go!</p>
<pre><code class="python">multi_slice_viewer(struct_arr2)
</code></pre>

<p><strong>&gt;&gt;&gt; Interactive images here! &lt;&lt;&lt;</strong></p>
<p>Matplotlib simply piles them on on top of each other.</p>
<p>K is a built-in keyboard shortcut to change the x-axis to use a logarithmic scale.<br />
If we want to use K exclusively, we have to remove it from matplotlib’s default<br />
key maps.</p>
<p>These live as lists in the <code>plt.rcParams</code> dictionary, which is matplotlib’s <br />
repository for default system-wide settings:</p>
<p><code>plt.rcParams['keymap.&lt;command&gt;'] = ['&lt;key1&gt;', '&lt;key2&gt;']</code> <br />
where pressing any of the keys in the list (i.e. <code>&lt;key1&gt;</code> or <code>&lt;key2&gt;</code>) <br />
will cause <code>&lt;command&gt;</code> to be executed.</p>
<p>Let’s rewrite the function.</p>
<pre><code class="python">def multi_slice_viewer(volume):
    remove_keymap_conflicts({'j', 'k'})
    fig, ax = plt.subplots()
    ax.volume = volume
    ax.index = volume.shape[0] // 2
    ax.imshow(volume[ax.index])
    fig.canvas.mpl_connect('key_press_event', process_key)

def process_key(event):
    fig = event.canvas.figure
    ax = fig.axes[0]
    if event.key == 'j':
        previous_slice(ax)
    elif event.key == 'k':
        next_slice(ax)
    fig.canvas.draw()

def previous_slice(ax):
    volume = ax.volume
    ax.index = (ax.index - 1) % volume.shape[0]  # wrap around using %
    ax.images[0].set_array(volume[ax.index])

def next_slice(ax):
    volume = ax.volume
    ax.index = (ax.index + 1) % volume.shape[0]
    ax.images[0].set_array(volume[ax.index])
</code></pre>

<p>We should be able to view all the slices in our MRI volume without pesky interference from the default keymap! <br />
One nice feature about this method is that it works on any matplotlib backend!</p>
<p>So, in the IPython terminal console, we will still get the same interaction as we did in the browser! <br />
And the same is true for a Qt or Tkinter app embedding a matplotlib plot.</p>
<p>This simple tool therefore lets us build ever more complex applications <br />
around matplotlib’s visualization capabilities.</p>
<pre><code class="python">#multi_slice_viewer(struct_arr2)
</code></pre>

<p>Delete the temporary directory.</p>
<pre><code class="python">d = tempfile.mkdtemp()

print(d)
</code></pre>

<pre><code>/tmp/tmpyylc3632
</code></pre>
<pre><code class="python">import shutil

# Remove the temporary directory
shutil.rmtree(d)
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Seaborn, Python Statistical Data Visualization Library/" class="btn btn-neutral float-right" title="Seaborn, Python's Statistical Data Visualization Library">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Matplotlib, Python Plotting/" class="btn btn-neutral" title="Matplotlib, Python Plotting"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>© Ugo Sparks</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Matplotlib, Python Plotting/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Seaborn, Python Statistical Data Visualization Library/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
      <script src="../mathjaxhelper.js"></script>

</body>
</html>
